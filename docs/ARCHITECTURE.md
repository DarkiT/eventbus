# EventBus æ¶æ„è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v0.2.0  
> **æ›´æ–°æ—¶é—´**: 2025-10-16  
> **çŠ¶æ€**: ç”Ÿäº§å°±ç»ª

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† EventBus äº‹ä»¶æ€»çº¿åº“çš„ç³»ç»Ÿæ¶æ„ã€æ ¸å¿ƒç»„ä»¶è®¾è®¡ã€æ€§èƒ½ç‰¹æ€§ä»¥åŠæœ€ä½³å®è·µã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚ï¼ˆApplicationï¼‰                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  å‘å¸ƒè€…   â”‚  â”‚  è®¢é˜…è€…   â”‚  â”‚  ç®¡ç†å™¨   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ ¸å¿ƒå±‚ï¼ˆEventBus Coreï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  EventBus ä¸»ç»„ä»¶                                  â”‚   â”‚
â”‚  â”‚  â€¢ äº‹ä»¶å‘å¸ƒ/è®¢é˜…  â€¢ ä¼˜å…ˆçº§å¤„ç†  â€¢ é€šé…ç¬¦åŒ¹é…    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Filter   â”‚  â”‚Middlewareâ”‚  â”‚  Tracer  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  CowMap   â”‚  â”‚   Pipe   â”‚  â”‚  Channel â”‚              â”‚
â”‚  â”‚ (å†™æ—¶å¤åˆ¶) â”‚  â”‚(æ³›å‹ç®¡é“)â”‚  â”‚(ä¼˜å…ˆçº§é˜Ÿåˆ—)â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **é«˜æ€§èƒ½**ï¼šå†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰æœºåˆ¶ä¼˜åŒ–è¯»å¤šå†™å°‘åœºæ™¯
2. **ç±»å‹å®‰å…¨**ï¼šæ³›å‹ç®¡é“æä¾›ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
3. **å¯æ‰©å±•**ï¼šæ’ä»¶åŒ–çš„è¿‡æ»¤å™¨å’Œä¸­é—´ä»¶æ¶æ„
4. **æ˜“ç”¨æ€§**ï¼šç®€æ´ç›´è§‚çš„ API è®¾è®¡
5. **å¯è§‚æµ‹**ï¼šå®Œæ•´çš„äº‹ä»¶è¿½è¸ªå’Œç›‘æ§èƒ½åŠ›

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. EventBus ä¸»ç»„ä»¶

**èŒè´£**ï¼š
- äº‹ä»¶å‘å¸ƒå’Œè®¢é˜…ç®¡ç†
- ä¸»é¢˜è·¯ç”±å’Œé€šé…ç¬¦åŒ¹é…
- ä¼˜å…ˆçº§å¤„ç†å’Œå¹¶å‘æ§åˆ¶
- ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ ¸å¿ƒç»“æ„**ï¼š
```go
type EventBus struct {
    bufferSize  int              // ç¼“å†²åŒºå¤§å°
    channels    *cowMap          // é€šé“æ˜ å°„è¡¨ï¼ˆå†™æ—¶å¤åˆ¶ï¼‰
    timeout     time.Duration    // é»˜è®¤è¶…æ—¶æ—¶é—´
    filters     []EventFilter    // äº‹ä»¶è¿‡æ»¤å™¨é“¾
    middlewares []Middleware     // ä¸­é—´ä»¶é“¾
    tracer      EventTracer      // äº‹ä»¶è¿½è¸ªå™¨
    lock        sync.RWMutex     // è¯»å†™é”
    closed      atomic.Bool      // å…³é—­çŠ¶æ€æ ‡å¿—
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒåŒæ­¥/å¼‚æ­¥å‘å¸ƒ
- âœ… å“åº”å¼åŒæ­¥å‘å¸ƒï¼ˆPublishSyncAll/Anyï¼‰
- âœ… å®Œæ•´çš„ Context æ”¯æŒ
- âœ… MQTT å…¼å®¹çš„é€šé…ç¬¦åŒ¹é…ï¼ˆ+ã€*ã€#ï¼‰
- âœ… å¤„ç†å™¨ä¼˜å…ˆçº§æ’åº

### 2. CowMapï¼ˆå†™æ—¶å¤åˆ¶æ˜ å°„ï¼‰

**è®¾è®¡ç†å¿µ**ï¼š
- ä¼˜åŒ–è¯»å¤šå†™å°‘åœºæ™¯
- è¯»æ“ä½œé›¶é”ç«äº‰
- å†™æ“ä½œè§¦å‘å®Œæ•´å¤åˆ¶

**å®ç°æœºåˆ¶**ï¼š
```go
type cowMap struct {
    mu    sync.RWMutex
    items atomic.Value  // å­˜å‚¨ map[interface{}]interface{}
}

// è¯»æ“ä½œï¼ˆæ— é”ï¼‰
func (c *cowMap) Load(key interface{}) (interface{}, bool) {
    items := c.items.Load().(map[interface{}]interface{})
    value, ok := items[key]
    return value, ok
}

// å†™æ“ä½œï¼ˆå¤åˆ¶ï¼‰
func (c *cowMap) Store(key, value interface{}) {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    oldMap := c.items.Load().(map[interface{}]interface{})
    newMap := maps.Clone(oldMap)  // å®Œæ•´å¤åˆ¶
    newMap[key] = value
    c.items.Store(newMap)
}
```

**æ€§èƒ½ç‰¹ç‚¹**ï¼š
- è¯»æ“ä½œï¼š13.30 ns/opï¼Œ0 å†…å­˜åˆ†é…
- å†™æ“ä½œï¼šé€‚åˆä½é¢‘æ›´æ–°åœºæ™¯
- å¹¶å‘è¯»å–ï¼šä¼˜äº sync.Map çº¦ 20-30%

### 3. Pipeï¼ˆæ³›å‹ç®¡é“ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š
- æä¾›ç±»å‹å®‰å…¨çš„æ¶ˆæ¯ä¼ é€’
- æ”¯æŒç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- æä½å»¶è¿Ÿçš„æ€§èƒ½

**æ ¸å¿ƒç»“æ„**ï¼š
```go
type Pipe[T any] struct {
    sync.RWMutex
    bufferSize int
    channel    chan T
    handlers   []*HandlerWithPriority[T]
    handlerMap map[uintptr]*HandlerWithPriority[T]
    closed     atomic.Bool
    stopCh     chan struct{}
    timeout    time.Duration
    ctx        context.Context
    cancel     context.CancelFunc
}
```

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
- åŒæ­¥å‘å¸ƒï¼š47.98 ns/op
- å†…å­˜å¼€é”€ï¼š8 B/op
- åˆ†é…æ¬¡æ•°ï¼š1 æ¬¡

### 4. Channelï¼ˆä¼˜å…ˆçº§é€šé“ï¼‰

**èŒè´£**ï¼š
- ç®¡ç†è®¢é˜…è€…å¤„ç†å™¨
- å®ç°ä¼˜å…ˆçº§æ’åº
- å¤„ç†å¹¶å‘æ´¾å‘

**ä¼˜å…ˆçº§æœºåˆ¶**ï¼š
```go
type channel struct {
    // æ™®é€šå¤„ç†å™¨ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰
    handlers []*HandlerWithPriority
    
    // å“åº”å¼å¤„ç†å™¨
    responseHandlers     []*ResponseHandlerWithPriority
    responseMap          map[string]*responseHandler
    
    // çŠ¶æ€ç®¡ç†
    ch     chan any
    closed atomic.Bool
    ctx    context.Context
    cancel context.CancelFunc
}
```

### 5. Filterï¼ˆæ™ºèƒ½è¿‡æ»¤å™¨ï¼‰

**åŠŸèƒ½**ï¼š
- ä¸»é¢˜é˜»æ–­
- é¢‘ç‡é™æµï¼ˆçª—å£ç®—æ³•ï¼‰
- å†…å®¹è¿‡æ»¤

**å®ç°ç¤ºä¾‹**ï¼š
```go
type SmartFilter struct {
    // é™æµé…ç½®
    limits map[string]*RateLimiter
    window time.Duration
    
    // é˜»æ–­åˆ—è¡¨
    blockedTopics map[string]bool
    mu sync.RWMutex
}
```

### 6. Middlewareï¼ˆä¸­é—´ä»¶ï¼‰

**èƒ½åŠ›**ï¼š
- æ•°æ®è½¬æ¢
- æ€§èƒ½ç›‘æ§
- æ—¥å¿—è®°å½•
- é”™è¯¯æ‹¦æˆª

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
type Middleware interface {
    Before(topic string, payload any) any
    After(topic string, payload any)
}
```

### 7. Tracerï¼ˆäº‹ä»¶è¿½è¸ªï¼‰

**è¿½è¸ªç‚¹**ï¼š
- OnPublishï¼šå‘å¸ƒäº‹ä»¶
- OnSubscribeï¼šè®¢é˜…äº‹ä»¶
- OnUnsubscribeï¼šå–æ¶ˆè®¢é˜…
- OnErrorï¼šé”™è¯¯å‘ç”Ÿ
- OnCompleteï¼šå¤„ç†å®Œæˆ
- OnQueueFullï¼šé˜Ÿåˆ—æ»¡
- OnSlowConsumerï¼šæ…¢æ¶ˆè´¹è€…

---

## ğŸš€ æ€§èƒ½ç‰¹æ€§

### æ€§èƒ½åŸºå‡†

| ç»„ä»¶ | æ“ä½œç±»å‹ | å»¶è¿Ÿ | å†…å­˜ | åˆ†é…æ¬¡æ•° |
|------|---------|------|------|----------|
| EventBus | åŒæ­¥å‘å¸ƒ | 595 ns/op | 111 B/op | 3 |
| EventBus | å¼‚æ­¥å‘å¸ƒ | 1,406 ns/op | 128 B/op | 2 |
| Pipe | åŒæ­¥å‘å¸ƒ | 47.98 ns/op | 8 B/op | 1 |
| CowMap | è¯»æ“ä½œ | 13.30 ns/op | 0 B/op | 0 |

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **è¯»ä¼˜åŒ–**
   - å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰æœºåˆ¶
   - åŸå­æ“ä½œé¿å…é”ç«äº‰
   - æ— é”è¯»å–è·¯å¾„

2. **å†™ä¼˜åŒ–**
   - æ™ºèƒ½å®¹é‡é¢„åˆ†é…
   - ç›¸åŒå€¼æ›´æ–°é¿å…å¤åˆ¶
   - æ‰¹é‡æ“ä½œæ”¯æŒ

3. **å¹¶å‘ä¼˜åŒ–**
   - Goroutine æ± 
   - Channel é€šä¿¡
   - ä¸Šä¸‹æ–‡æ§åˆ¶

---

## ğŸ” å¹¶å‘å®‰å…¨è®¾è®¡

### å¹¶å‘æ¨¡å‹

```
å‘å¸ƒçº¿ç¨‹                è®¢é˜…çº¿ç¨‹               ç®¡ç†çº¿ç¨‹
   â†“                      â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Publishâ”‚           â”‚Handler â”‚            â”‚Subscribeâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                    â†‘                      â†“
     â””â”€â”€â”€â”€â†’ [Channel] â”€â”€â”€â”€â”˜              [CowMapå†™é”]
              (æ— é”è¯»)                     (ä¸²è¡ŒåŒ–å†™)
```

### é”ç­–ç•¥

1. **CowMap**ï¼š
   - è¯»æ“ä½œï¼šæ— é”ï¼ˆatomic.Valueï¼‰
   - å†™æ“ä½œï¼šäº’æ–¥é”ä¿æŠ¤

2. **Channel**ï¼š
   - å¤„ç†å™¨åˆ—è¡¨ï¼šè¯»å†™é”
   - æ¶ˆæ¯é€šé“ï¼šGo åŸç”Ÿå¹¶å‘å®‰å…¨

3. **EventBus**ï¼š
   - é…ç½®ä¿®æ”¹ï¼šè¯»å†™é”
   - çŠ¶æ€æ ‡å¿—ï¼šåŸå­æ“ä½œ

### ç«æ€æ£€æµ‹

æ‰€æœ‰ä»£ç é€šè¿‡ `go test -race` éªŒè¯ï¼Œç¡®ä¿æ— æ•°æ®ç«äº‰ã€‚

---

## ğŸ“Š æ•°æ®æµ

### äº‹ä»¶å‘å¸ƒæµç¨‹

```
1. åº”ç”¨è°ƒç”¨ Publish()
        â†“
2. è¿‡æ»¤å™¨é“¾æ£€æŸ¥ï¼ˆFilterï¼‰
        â†“
3. ä¸­é—´ä»¶å‰ç½®å¤„ç†ï¼ˆBeforeï¼‰
        â†“
4. ä¸»é¢˜åŒ¹é…ï¼ˆé€šé…ç¬¦æ”¯æŒï¼‰
        â†“
5. å¤„ç†å™¨æŒ‰ä¼˜å…ˆçº§æ’åº
        â†“
6. å¹¶å‘/é¡ºåºæ‰§è¡Œå¤„ç†å™¨
        â†“
7. ä¸­é—´ä»¶åç½®å¤„ç†ï¼ˆAfterï¼‰
        â†“
8. è¿½è¸ªå™¨è®°å½•ï¼ˆOnCompleteï¼‰
```

### å“åº”å¼å‘å¸ƒæµç¨‹

```
1. PublishSyncAll/Any è°ƒç”¨
        â†“
2. Context åˆ›å»ºï¼ˆå¸¦è¶…æ—¶ï¼‰
        â†“
3. å¹¶å‘æ‰§è¡Œå“åº”å¼å¤„ç†å™¨
        â†“
4. æ”¶é›†è¿”å›å€¼å’Œé”™è¯¯
        â†“
5. æ ¹æ®ç­–ç•¥åˆ¤æ–­æˆåŠŸ/å¤±è´¥
   â€¢ All: å…¨éƒ¨æˆåŠŸæ‰è¿”å›
   â€¢ Any: ä»»ä¸€æˆåŠŸå³è¿”å›
        â†“
6. è¿”å› SyncResult
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### é”™è¯¯åˆ†ç±»

1. **å‚æ•°é”™è¯¯**ï¼š
   - ErrHandlerIsNotFunc
   - ErrHandlerParamNum
   - ErrInvalidTopic

2. **çŠ¶æ€é”™è¯¯**ï¼š
   - ErrChannelClosed
   - ErrEventBusClosed

3. **è¿è¡Œæ—¶é”™è¯¯**ï¼š
   - ErrPublishTimeout
   - ErrNoSubscriber

### é”™è¯¯å¤„ç†ç­–ç•¥

```go
// 1. åŒæ­¥é”™è¯¯ï¼šç«‹å³è¿”å›
if err := bus.Subscribe(topic, handler); err != nil {
    return err
}

// 2. å¼‚æ­¥é”™è¯¯ï¼šé€šè¿‡ Tracer æŠ¥å‘Š
tracer.OnError(topic, err)

// 3. è¶…æ—¶é”™è¯¯ï¼šContext æ§åˆ¶
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()
err := bus.PublishSyncWithContext(ctx, topic, payload)
```

---

## ğŸ“ˆ å¯è§‚æµ‹æ€§

### å¥åº·æ£€æŸ¥

```go
status := bus.HealthCheck()
// è¿”å›ï¼š
// - Healthy: bool
// - Message: string
// - Details: map[string]interface{}
```

### ç»Ÿè®¡ä¿¡æ¯

```go
stats := bus.GetStats()
// åŒ…å«ï¼š
// - SubscriberCount: è®¢é˜…è€…æ•°é‡
// - TopicCount: ä¸»é¢˜æ•°é‡
// - QueueDepth: é˜Ÿåˆ—æ·±åº¦
// - ProcessedEvents: å·²å¤„ç†äº‹ä»¶æ•°
```

### äº‹ä»¶è¿½è¸ª

```go
type MetricsTracer struct {
    publishCount    map[string]int64
    errorCount      map[string]int64
    avgLatency      map[string]time.Duration
    subscribeCount  map[string]int32
}
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯

âœ… **æ¨èä½¿ç”¨**ï¼š
- å¾®æœåŠ¡äº‹ä»¶é€šä¿¡
- å®æ—¶æ•°æ®å¤„ç†
- çŠ¶æ€å˜æ›´é€šçŸ¥
- ç”¨æˆ·è¡Œä¸ºè¿½è¸ª
- ä¸šåŠ¡æµç¨‹ç¼–æ’

### è°¨æ…åœºæ™¯

âš ï¸ **éœ€è¦è¯„ä¼°**ï¼š
- é¢‘ç¹è®¢é˜…/å–æ¶ˆè®¢é˜…ï¼ˆCowMapå†™æ€§èƒ½é™åˆ¶ï¼‰
- å¤§é‡åŠ¨æ€ä¸»é¢˜ï¼ˆå†…å­˜å¼€é”€ï¼‰
- è¶…å¤§æ¶ˆæ¯è´Ÿè½½ï¼ˆå»ºè®®ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰

---

## ğŸ”„ æ‰©å±•æ€§

### æ’ä»¶åŒ–æ¶æ„

```go
// è‡ªå®šä¹‰è¿‡æ»¤å™¨
type MyFilter struct{}
func (f *MyFilter) Filter(topic string, payload any) bool {
    // å®ç°è¿‡æ»¤é€»è¾‘
}
bus.AddFilter(&MyFilter{})

// è‡ªå®šä¹‰ä¸­é—´ä»¶
type MyMiddleware struct{}
func (m *MyMiddleware) Before(topic string, payload any) any {
    // å‰ç½®å¤„ç†
}
bus.Use(&MyMiddleware{})

// è‡ªå®šä¹‰è¿½è¸ªå™¨
type MyTracer struct{}
func (t *MyTracer) OnPublish(topic string, payload any, meta PublishMetadata) {
    // è¿½è¸ªé€»è¾‘
}
bus.SetTracer(&MyTracer{})
```

### æœªæ¥æ‰©å±•æ–¹å‘

- ğŸ”® åˆ†å¸ƒå¼äº‹ä»¶æ€»çº¿
- ğŸ”® æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—
- ğŸ”® é›†ç¾¤æ¨¡å¼æ”¯æŒ
- ğŸ”® å¤šä¼ è¾“åè®®æ”¯æŒ

---

## ğŸ“š æœ€ä½³å®è·µ

### 1. ç¼“å†²åŒºé…ç½®

```go
// é«˜ååé‡åœºæ™¯
bus := eventbus.NewBuffered(10000)

// ä½å»¶è¿Ÿåœºæ™¯
bus := eventbus.New()  // æ— ç¼“å†²

// å¹³è¡¡é…ç½®
bus := eventbus.NewBuffered(1024)
```

### 2. ä¼˜å…ˆçº§ä½¿ç”¨

```go
// å…³é”®ä¸šåŠ¡ï¼šé«˜ä¼˜å…ˆçº§
bus.SubscribeWithPriority("order.payment", criticalHandler, 10)

// æ—¥å¿—è®°å½•ï¼šä½ä¼˜å…ˆçº§
bus.SubscribeWithPriority("order.payment", logHandler, 1)
```

### 3. Context ç®¡ç†

```go
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()

// åŒæ­¥å‘å¸ƒï¼šæ•´ä¸ªé“¾è·¯å— Context æ§åˆ¶
err := bus.PublishSyncWithContext(ctx, topic, payload)

// å¼‚æ­¥å‘å¸ƒï¼šä»…æŠ•é€’å‰æ£€æŸ¥ Context
err := bus.PublishAsyncWithContext(ctx, topic, payload)
```

### 4. èµ„æºæ¸…ç†

```go
// åº”ç”¨é€€å‡ºæ—¶å…³é—­
defer bus.Close()

// ä¸éœ€è¦çš„è®¢é˜…åŠæ—¶å–æ¶ˆ
bus.Unsubscribe(topic, handler)
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [API æ¥å£è®¾è®¡](./APIæ¥å£è®¾è®¡.md) - è¯¦ç»†çš„ API è¯´æ˜
- [æ€§èƒ½è¯„ä¼°æŠ¥å‘Š](./æ€§èƒ½è¯„ä¼°æŠ¥å‘Š.md) - æ€§èƒ½åŸºå‡†æµ‹è¯•
- [é¡¹ç›®æ¦‚è¿°](./é¡¹ç›®æ¦‚è¿°.md) - é¡¹ç›®ä»‹ç»
- [MQTT å…¼å®¹æ€§](./MQTT_COMPATIBILITY.md) - MQTT é€šé…ç¬¦æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v0.2.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**ç»´æŠ¤è€…**: EventBus Team
